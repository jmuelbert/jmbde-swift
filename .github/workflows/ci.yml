---
# SPDX-FileCopyrightText: ¬© 2016-2023 J√ºrgen M√ºlbert
#
# SPDX-License-Identifier: EUPL-1.2
#

name: CI

on: # yamllint disable-line rule:truthy
  push:
    branches:
      - main
    paths:
      - jmbde/**
      - jmbdeTests/**
      - jmbdeUITests/**
      - jmbde.xcodeproj/**
      - jmbde.xcworkspace/**
      - Package.swift
      - Podfile
      - .github/workflows/ci.yml

    pull_request:
      types: [opened, synchronize, reopened]

permissions:
  contents: read

concurrency:
  group: ${{ github.ref }}-${{ github.workflow }}
  cancel-in-progress: true

env:
  TARGET_NAME: jmbde
  FRAMEWORK_NAME: jmbde
  SCHEME: jmbde
  CACHE_NAME: SWIFT5
  PROJECT_WORKSPACE: jmbde.xcworkspace
  SDK: macosx10.15
  DESTINATION: "arch=x86_64"
  SWIFT_VERSION: 5.5
  LC_CTYPE: en_US.UTF-8
  LANG: en_US.UTF-8
  UPDATE_DOCS: true
  EXPANDED_CODE_SIGN_IDENTITY: "-"
  EXPANDED_CODE_SIGN_IDENTITY_NAME: "-"
  XCODEGEN_VERSION: 2.5.0

jobs:
  build:
    name: "Build macos for ${{ matrix.destination}}"
    runs-on: macos-latest
    needs: tests

    strategy:
      matrix:
        destination: [
            # "'platform=macOS,variant=Mac Catalyst'",
            "'platform=macOS'",
          ]
        fail-fast: false

    steps:
      - name: "üß∞ Checkout Source Code"
        if: github.event_name == 'push'
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: "‚öôÔ∏è Set XCode Version"
        run: sudo xcode-select -s /Applications/Xcode_13.2.1.app

      - name: "‚öôÔ∏è Initailize the bundler cache"
        uses: actions/cache@v3
        id: bundler-cache
        with:
          path: vendor/bundle
          key: ${{ runner.os }}-gems-${{ hashFiles('**/Gemfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-gems-

      - name: "‚öôÔ∏è Bundle setup"
        run: bundle config path vendor/bundle

      - name: "‚öôÔ∏è Bundle install"
        if: steps.bundler-cache.outputs.cache-hit != 'true'
        run: bundle install --jobs 4 --retry 3

      - name: "üöß Compile and build üì¶ application"
        run: |
          pod install || pod install --repo-update
          set -o pipefail && xcodebuild \
            -workspace "jmbde.xcworkspace" \
            -scheme "jmbde" \
            -destination ${{ matrix.destination }} \
            -configuration "Release" \
            -derivedDataPath build/ \
            clean build | xcpretty
            ls -aL build/Build/Products/Release

      - name: Upload Artifact
        uses: actions/upload-artifact@v3
        with:
          name: jmbde-macOS
          path: build/Build/Products/Release/jmbde*

  tests:
    name: "Tests on macos-latest"
    runs-on: macos-latest

    strategy:
      fail-fast: false
      matrix:
        xcode: ["13.2.1", "13.4.1", "14.1"]

    steps:
      - name: "üß∞ Checkout Source Code"
        if: github.event_name == 'push'
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Fetch all history for all tags and branches
        run: git fetch --prune --unshallow

      - name: Cache dependencies
        uses: actions/cache@v2
        with:
          path: |
            .build/artifacts
            .build/checkouts
            .build/repositories
          key: ${{ runner.os }}-dependencies-${{ matrix.xcode }}-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-dependencies-${{ matrix.xcode }}-${{ hashFiles('**/Package.resolved') }}
            ${{ runner.os }}-dependencies-${{ matrix.xcode }}-

       - name: "‚öôÔ∏è Select Xcode"
        run: |
          xcodebuild -version
          ls -nt /Applications/ | grep "Xcode*"
          sudo xcode-select -switch /Applications/Xcode_${{ matrix.xcode }}.app
          xcodebuild -version

      - name: "‚öôÔ∏è Initailize the bundler cache"
        uses: actions/cache@v3
        id: bundler-cache
        with:
          path: vendor/bundle
          key: ${{ runner.os }}-gems-${{ hashFiles('**/Gemfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-gems-

      - name: "‚öôÔ∏è Bundle setup"
        run: bundle config path vendor/bundle

      - name: "‚öôÔ∏è Bundle install"
        if: steps.bundler-cache.outputs.cache-hit != 'true'
        run: bundle install --jobs 4 --retry 3

      - name: "‚öôÔ∏è pod install"
        run: |
          pod install || pod install --repo-update

      - name: Install danger-js
        run: brew install danger/tap/danger-js

      - run: swift run danger-swift ci --verbose --failOnErrors
        if: ${{ github.event_name == 'pull_request' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }

      - name: "üöß build and test üì¶ application"
        run: |
          set -o pipefail && xcodebuild  \
            -workspace "jmbde.xcworkspace" \
            -scheme "jmbde" \
            -destination "platform=macOS" \
            -configuration "Debug" \
            -enableCodeCoverage YES \
            -showBuildTimingSummary \
            -derivedDataPath Build/ \
            -enableThreadSanitizer YES \
            clean test | xcpretty


  releaseNotes:
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Fetch all history for all tags and branches
        run: git fetch --prune --unshallow

      - name: Build Releasenotes
        id: github_releasenotes
        uses: release-drafter/release-drafter@v5.24.0
        with:
          publish: "${{ steps.check-version.outputs.tag != '' }}"
          tag: "${{ steps.check-version.outputs.tag }}"
          env:
            GITHUB_TOKEN: "${{ secrets.GITHUB_TOKEN }}"

  changeLog:
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    steps:
      - name: Build Changelog
        id: github_release
        uses: mikepenz/release-changelog-builder-action@v4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Release
        uses: mikepenz/action-gh-release@v0.2.0-a03 #softprops/action-gh-release
        with:
          body: ${{steps.github_release.outputs.changelog}}

  deployPrereleases:
    name: Deploy Pre-Release
    if: github.ref == 'refs/heads/master'
    runs-on: ubuntu-20.04
    environment: PreRelease
    needs:
      - build

    steps:
      - name: Pre-Release
        run: echo "here comes the pre release"

      - name: Download builded app (Artifact)
        uses: actions/download-artifact@v3
        with:
          name: jmbde-macOS
          path: build/

  deploy:
    name: deploy the Release
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-20.04
    environment: Release
    needs:
      - build
      - changeLog
      - releaseNotes

    steps:
      - name: Release
        run: |
          echo "here comes the release."

      - name: Download builded app (Artifact)
        uses: actions/download-artifact@v3
        with:
          name: jmbde-macOS
          path: build/
