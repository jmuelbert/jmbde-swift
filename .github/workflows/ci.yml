---
# SPDX-FileCopyrightText: ¬© 2016-2023 J√ºrgen M√ºlbert
#
# SPDX-License-Identifier: EUPL-1.2
#

# This script performs continuous integration
# tasks for the JMBeData project

name: CI

on: # yamllint disable-line rule:truthy
  push:
    paths:
      - JMBeData/**
      - JMBeDataTests/**
      - JMBeDataUITests/**
      - JMBeData.xcodeproj/**
      - .github/workflows/ci.yml

  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read

concurrency:
  group: ${{ github.ref }}-${{ github.workflow }}
  cancel-in-progress: true

env:
  TARGET_NAME: JMBeData
  SCHEME: JMBeData
  ARCH: x86_64
  PROJECT_NAME: JMBeData.xcodeproj
  LC_CTYPE: en_US.UTF-8
  LANG: en_US.UTF-8
  UPDATE_DOCS: true
  EXPANDED_CODE_SIGN_IDENTITY: "-"
  EXPANDED_CODE_SIGN_IDENTITY_NAME: "-"

jobs:
  build:
    name: "Build macos for ${{ matrix.destination}}"
    runs-on: macos-13
    needs: tests

    strategy:
      matrix:
        destination: ["'platform=macOS'"]
      fail-fast: false

    steps:
      - name: "üß∞ Checkout Source Code"
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - name: "‚öôÔ∏è Set XCode Version"
        run: sudo xcode-select -s /Applications/Xcode_15.0.1.app

      - name: "üöß Compile and build üì¶ application"
        run: |
          set -o pipefail && xcodebuild  \
            -project ${{ env.PROJECT_NAME }} \
            -scheme ${{ env.TARGET_NAME }} \
            -destination ${{ matrix.destination }} \
            -configuration "Release" \
            -derivedDataPath build/ \
            clean build | xcpretty
            ls -aL build/Build/Products/Release

      - name: "Upload artifact"
        uses: actions/upload-artifact@a8a3f3ad30e3422c9c7b888a15615d19a852ae32 # v3.1.3
        with:
          name: jmbde-macOS
          path: build/Build/Products/Release/jmbde*

  tests:
    name: "Tests on macos-latest"
    runs-on: macos-13

    strategy:
      fail-fast: false
      matrix:
        xcode: ["15.0.1"]
        destination: ["'platform=macOS'"]

    steps:
      - name: "üß∞ Checkout Source Code"
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - name: "‚öôÔ∏è Select Xcode"
        run: |
          xcodebuild -version
          ls -nt /Applications/ | grep "Xcode*"
          sudo xcode-select -switch /Applications/Xcode_${{ matrix.xcode }}.app
          xcodebuild -version

      - name: "üöß build and test üì¶ application"
        run: |
          set -o pipefail && xcodebuild  \
            -project ${{ env.PROJECT_NAME }} \
            -destination ${{ matrix.destination }} \
            -scheme ${{ env.TARGET_NAME }} \
            -configuration "Debug" \
            -enableCodeCoverage YES \
            -showBuildTimingSummary \
            -derivedDataPath Build/ \
            -enableThreadSanitizer YES \
            clean test | xcpretty

            bash <(curl -s https://codecov.io/bash)

  deployPrereleases:
    name: Deploy Pre-Release
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment: PreRelease
    needs:
      - build

    steps:
      - name: Pre-Release
        run: echo "here comes the pre release"

      - name: Download builded app (Artifact)
        uses: actions/download-artifact@cbed621e49e4c01b044d60f6c80ea4ed6328b281 # v2.1.1
        with:
          name: jmbde-macOS
          path: build/

  deploy:
    name: deploy the Release
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    environment: Release
    needs:
      - build

    steps:
      - name: Release
        run: |
          echo "here comes the release."

      - name: Download builded app (Artifact)
        uses: actions/download-artifact@cbed621e49e4c01b044d60f6c80ea4ed6328b281 # v2.1.1
        with:
          name: jmbde-macOS
          path: build/
