---
# SPDX-FileCopyrightText: ¬© 2016-2023 J√ºrgen M√ºlbert
#
# SPDX-License-Identifier: EUPL-1.2
#

# This script performs continuous integration
# tasks for the JMBeData project

name: CI

on: # yamllint disable-line rule:truthy
  push:
    paths:
      - JMBeData/**
      - JMBeDataTests/**
      - JMBeDataUITests/**
      - JMBeData.xcodeproj/**
      - .github/workflows/ci.yml

  pull_request:
    types: [opened, synchronize, reopened]

  release:
    types: [published]

  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ${{ github.ref }}-${{ github.workflow }}
  cancel-in-progress: true

env:
  TARGET_NAME: JMBeData
  SCHEME: JMBeData
  ARCH: x86_64
  PROJECT_NAME: JMBeData.xcodeproj
  LC_CTYPE: en_US.UTF-8
  LANG: en_US.UTF-8
  UPDATE_DOCS: true
  EXPANDED_CODE_SIGN_IDENTITY: "-"
  EXPANDED_CODE_SIGN_IDENTITY_NAME: "-"

jobs:
  tests:
    if: ${{ !contains(github.event.head_commit.message, '[skip ci]') }} || (github.actor != 'dependabot[bot]')
    name: "Tests on macos-latest"
    runs-on: macos-13

    strategy:
      fail-fast: false
      matrix:
        xcode_version: ["15.0.1"]
        destination: ["'platform=macOS'"]

    steps:
      - name: "üß∞ Checkout Source Code"
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - name: "üçé ‚öôÔ∏è Select Xcode version"
        shell: bash
        run: |
          sudo xcode-select -s /Applications/Xcode_${{ matrix.xcode_version }}.app && /usr/bin/xcodebuild -version

      - name: "üöß build and test üì¶ application"
        run: |
          set -o pipefail && xcodebuild  \
            -project ${{ env.PROJECT_NAME }} \
            -destination ${{ matrix.destination }} \
            -scheme ${{ env.TARGET_NAME }} \
            -configuration "Debug" \
            -enableCodeCoverage YES \
            -showBuildTimingSummary \
            -derivedDataPath Build/ \
            -enableThreadSanitizer YES \
            clean test | xcpretty

            bash <(curl -s https://codecov.io/bash)

  build:
    name: "Build macos for ${{ matrix.destination}}"
    runs-on: macos-13
    needs: tests

    strategy:
      matrix:
        xcode_version: ["15.0.1"]
        destination: ["'platform=macOS'"]
      fail-fast: false

    steps:
      - name: "üß∞ Checkout Source Code"
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - name: "üçé ‚öôÔ∏è Select Xcode version"
        shell: bash
        run: |
          sudo xcode-select -s /Applications/Xcode_${{ matrix.xcode_version }}.app && /usr/bin/xcodebuild -version

      - name: "üöß Compile and build üì¶ application"
        run: |
          set -o pipefail && xcodebuild  \
            -project ${{ env.PROJECT_NAME }} \
            -scheme ${{ env.TARGET_NAME }} \
            -destination ${{ matrix.destination }} \
            -configuration "Release" \
            -derivedDataPath build/ \
            clean build | xcpretty
            ls -aL build/Build/Products/Release

      - name: "üì§ Upload artifact"
        uses: actions/upload-artifact@c7d193f32edcb7bfad88892161225aeda64e9392 # v4.0.0
        with:
          name: jmbde-macOS
          path: build/Build/Products/Release/jmbde*

  deployPrereleases:
    name: Deploy Pre-Release
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment: PreRelease
    needs:
      - build

    steps:
      - name: Pre-Release
        run: echo "here comes the pre release"

      - name: Download builded app (Artifact)
        uses: actions/download-artifact@f44cd7b40bfd40b6aa1cc1b9b5b7bf03d3c67110 # v4.1.1
        with:
          name: jmbde-macOS
          path: build/

  deploy:
    name: deploy the Release
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    environment: Release
    needs:
      - build

    steps:
      - name: Release
        run: |
          echo "here comes the release."

      - name: Download builded app (Artifact)
        uses: actions/download-artifact@f44cd7b40bfd40b6aa1cc1b9b5b7bf03d3c67110 # v4.1.1
        with:
          name: jmbde-macOS
          path: build/
